<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
    <title>Websocket client</title>
    <style type="text/css">
   circle {
     fill: none;
     stroke-width: 1.5px;
   }
       </style>
    <script src="/static/jquery.min.js"></script>
	<script type="text/javascript" src="http://mbostock.github.com/d3/d3.js?1.25.0"></script>
    <script type="text/javascript">
      var websocket;
      $(document).ready(init);
      function init() {
          if(!("WebSocket" in window)){  
              $('#status').append('<p><span style="color: red;">websockets are not supported </span></p>');
              $("#navigation").hide();  
          } else {
              $('#status').append('<p><span style="color: green;">websockets are supported </span></p>');
              connect();
          };
              $("#connected").hide(); 	
              $("#content").hide(); 
      };
      function connect()
      {
          wsHost = $("#server").val()
          websocket = new WebSocket(wsHost);
          showScreen('<b>Connecting to: ' +  wsHost + '</b>'); 
          websocket.onopen = function(evt) { onOpen(evt) }; 
          websocket.onclose = function(evt) { onClose(evt) }; 
          websocket.onmessage = function(evt) { onMessage(evt) }; 
          websocket.onerror = function(evt) { onError(evt) }; 
      };  
      
      function disconnect() {
          websocket.close();
      }; 
      function toggle_connection(){
          if(websocket.readyState == websocket.OPEN){
              disconnect();
          } else {
              connect();
          };
      };

      function sendTxt() {
          if(websocket.readyState == websocket.OPEN){
              txt = $("#send_txt").val();
              websocket.send(txt);
              showScreen('sending: ' + txt); 
          } else {
               showScreen('websocket is not connected'); 
          };
      };

      function onOpen(evt) { 
          showScreen('<span style="color: green;">CONNECTED </span>'); 
          $("#connected").fadeIn('slow');
          $("#content").fadeIn('slow');
      };  

      function onClose(evt) { 
          showScreen('<span style="color: red;">DISCONNECTED </span>');
      };  
      function onMessage(evt) { 
          showScreen('<span style="color: blue;">RESPONSE: ' + evt.data+ '</span>'); 

		  var data = evt.data.split(",");
		  var nodeA = [0,0];
		  var nodeB = [100, 0];
		  var nodeC = [0, 100];
		  svg.append("svg:circle")
		  	.attr("cx", nodeA[0]+ (w/2))
		  	.attr("cy", nodeA[1]+ (h/2))
			.attr("r", 100-data[1])
	        .style("stroke", z(data[0]))
	        .style("stroke-opacity", 1)
			.transition()
	        .duration(1000)
	        .ease(Math.sqrt)
	        .attr("r", 1.5*(100-data[1]))
	        .style("stroke-opacity", 1e-6)
	        .remove();
			
			svg.append("svg:circle")
		  	.attr("cx", nodeB[0]+ (w/2))
		  	.attr("cy", nodeB[1]+ (h/2))
			.attr("r", 100-data[2])
	        .style("stroke", z(data[0]))
	        .style("stroke-opacity", 1)
			.transition()
	        .duration(1000)
	        .ease(Math.sqrt)
	        .attr("r", 1.5*(100-data[2]))
	        .style("stroke-opacity", 1e-6)
	        .remove();
			
			svg.append("svg:circle")
		  	.attr("cx", nodeC[0] + (w/2))
		  	.attr("cy", nodeC[1] + (h/2))
			.attr("r", 100-data[3])
	        .style("stroke", z(data[0]))
	        .style("stroke-opacity", 1)
			.transition()
	        .duration(1000)
	        .ease(Math.sqrt)
	        .attr("r", 1.5*(100-data[3]))
	        .style("stroke-opacity", 1e-6)
	        .remove();
		  /*
		  
		  var cvs = $('#cvs')[0].getContext('2d');
		  
		  // drawing nodeA: x, y, radius
		  cvs.beginPath();
		  cvs.arc(nodeA[0]+100,nodeA[1]+100,-data[1],0,Math.PI * 2, true);
		  cvs.fillStyle = 'rgba(255,0,0,0.5)';
		  cvs.fill();
		  cvs.closePath();
		  // drawing nodeB: x, y, radius
		  cvs.beginPath();
		  cvs.arc(nodeB[0]+100,nodeB[1]+100,-data[2],0,Math.PI * 2, true);
		  cvs.fillStyle = 'rgba(0,255,0,0.5)';
		  cvs.fill();
		  cvs.closePath();
		  // drawing nodeC: x, y, radius
		  cvs.beginPath();
		  cvs.arc(nodeC[0]+100,nodeC[1]+100,-data[3],0,Math.PI * 2, true);
		  cvs.fillStyle = 'rgba(0,0,255,0.5)';
		  cvs.fill();
		  cvs.closePath();*/
      };  

      function onError(evt) {
          showScreen('<span style="color: red;">ERROR: ' + evt.data+ '</span>');
      };

      function showScreen(txt) {
		  /*$('<p>' + txt + '</p>').hide().prependTo('#output').slideDown('slow');
          $('#output').children().slice(14).fadeOut('fast', function() {
			  $('this').remove();
          });*/
		  $('#output').prepend('<p>' + txt +'</p>'); 
      };

      function clearScreen() 
      { 
          $('#output').html("");
      };
	  
    </script>
  </head>

  <body>
	  <script type="text/javascript">
	  var w = 960,
	      h = 500,
	      z = d3.scale.category20c(),
		  i = 0;

	  var svg = d3.select("body").append("svg:svg")
	      .attr("width", w)
	      .attr("height", h);
	  </script>
    <div id="header">
      <h1>Websocket client</h1>
      <div id="status"></div>
    </div>


    <div id="navigation">

      <p id="connecting">
	<input type='text' id="server" value="ws://localhost:8080/websocket"></input>
	<button type="button" onclick="toggle_connection()">connection</button>
      </p>
      <div id="connected">				
	<p>
	  <input type='text' id="send_txt" value=></input>
	  <button type="button" onclick="sendTxt();">send</button>
	</p>
      </div>

      <div id="content">						
	<button id="clear" onclick="clearScreen()" >Clear text</button>
	<canvas id="cvs"></canvas>
	<div id="output"></div>
      </div>

    </div>
  </body>
</html> 
